<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Vacation Care</title>
    
    <!-- Tailwind CSS for rapid UI development -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- i18next for internationalization -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom CSS -->
    <style>
        /* Estilos base y para modo claro */
        :root {
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover: #2563eb; /* blue-600 */
        }

        /* Estilos para modo oscuro */
        body.dark {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --accent-hover: #3b82f6; /* blue-500 */
        }

        /* Aplicación de variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card, .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        .form-input {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .nav-link {
            color: var(--text-secondary);
        }
        .nav-link:hover {
            color: var(--accent-color);
        }
        .prose {
             color: var(--text-primary);
        }
        .prose h1, .prose h2, .prose h3 {
             color: var(--text-primary);
        }
        .prose a {
             color: var(--accent-color);
        }

        /* Animación para la carga de vistas */
        #app {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="root" class="min-h-screen flex flex-col">
        <!-- El Navbar se renderizará aquí -->
        <header id="navbar-container"></header>
        
        <!-- Contenido principal de la SPA -->
        <main id="app" class="flex-grow container mx-auto p-4 md:p-6 lg:p-8">
            <!-- Las vistas se inyectarán aquí -->
        </main>

        <!-- El Footer se renderizará aquí -->
        <footer id="footer-container" class="p-4 text-center text-sm" style="color: var(--text-secondary);"></footer>
    </div>

    <!-- Módulo principal de JavaScript -->
    <script type="module">
        // ===================================================================================
        // SIMULATED BACKEND (server/database.json & src/js/api.js)
        // En un proyecto real, esto sería un servidor aparte (json-server)
        // y las funciones harían peticiones fetch reales.
        // ===================================================================================
        const api = (() => {
            // --- Base de datos simulada ---
            let db = {
                roles: [
                    { id: 1, name: "customer" },
                    { id: 2, name: "worker" }
                ],
                users: [
                    { id: 1, name: "Admin Worker", email: "worker@pets.com", password: "password123", roleId: 2 },
                    { id: 2, name: "John Doe", email: "john@doe.com", password: "password123", roleId: 1 }
                ],
                pets: [
                    { id: 1, name: "Buddy", type: "Dog", breed: "Golden Retriever", userId: 2 },
                    { id: 2, name: "Lucy", type: "Cat", breed: "Siamese", userId: 2 }
                ],
                stays: [
                    { id: 1, petId: 1, userId: 2, startDate: "2025-07-15", duration: 7, status: "active" },
                    { id: 2, petId: 2, userId: 2, startDate: "2025-06-01", duration: 10, status: "completed" }
                ]
            };

            const simulateDelay = (ms = 500) => new Promise(res => setTimeout(res, ms));

            const getNextId = (collection) => {
                const maxId = db[collection].reduce((max, item) => item.id > max ? item.id : max, 0);
                return maxId + 1;
            };

            return {
                // GET /collection
                // GET /collection?_expand=relation
                find: async (collection, query = {}) => {
                    await simulateDelay();
                    let data = [...db[collection]];
                    
                    // Simular _expand
                    if (query._expand) {
                        data = data.map(item => {
                            const relationName = query._expand;
                            const relationId = item[`${relationName}Id`];
                            const relationData = db[`${relationName}s`].find(r => r.id === relationId);
                            return { ...item, [relationName]: relationData };
                        });
                    }

                    // Simular filtros (ej: ?userId=2)
                    Object.keys(query).forEach(key => {
                        if (key !== '_expand') {
                            data = data.filter(item => String(item[key]) === String(query[key]));
                        }
                    });

                    console.log(`API GET: /${collection}`, query, data);
                    return data;
                },
                // GET /collection/:id
                findOne: async (collection, id, query = {}) => {
                    await simulateDelay();
                    let item = db[collection].find(item => item.id === parseInt(id));
                    
                    if (item && query._expand) {
                        const relationName = query._expand;
                        const relationId = item[`${relationName}Id`];
                        const relationData = db[`${relationName}s`].find(r => r.id === relationId);
                        item = { ...item, [relationName]: relationData };
                    }
                    
                    console.log(`API GET: /${collection}/${id}`, item);
                    return item;
                },
                // POST /collection
                create: async (collection, newItem) => {
                    await simulateDelay();
                    const itemWithId = { ...newItem, id: getNextId(collection) };
                    db[collection].push(itemWithId);
                    console.log(`API POST: /${collection}`, itemWithId);
                    return itemWithId;
                },
                // PUT /collection/:id
                update: async (collection, id, updatedData) => {
                    await simulateDelay();
                    const index = db[collection].findIndex(item => item.id === parseInt(id));
                    if (index !== -1) {
                        db[collection][index] = { ...db[collection][index], ...updatedData };
                        console.log(`API PUT: /${collection}/${id}`, db[collection][index]);
                        return db[collection][index];
                    }
                    return null;
                },
                // DELETE /collection/:id
                remove: async (collection, id) => {
                    await simulateDelay();
                    const index = db[collection].findIndex(item => item.id === parseInt(id));
                    if (index !== -1) {
                        db[collection].splice(index, 1);
                        console.log(`API DELETE: /${collection}/${id}`);
                        return { success: true };
                    }
                    return null;
                }
            };
        })();

        // ===================================================================================
        // I18N MODULE (src/js/i18n.js)
        // ===================================================================================
        const i18n = {
            init: async () => {
                const resources = {
                    es: {
                        translation: {
                            // Navbar & Footer
                            "nav_home": "Inicio",
                            "nav_dashboard": "Panel",
                            "nav_login": "Iniciar Sesión",
                            "nav_register": "Registrarse",
                            "nav_logout": "Cerrar Sesión",
                            "theme_toggle": "Cambiar tema",
                            "lang_toggle": "Cambiar idioma",
                            "footer_text": "© 2025 Pet Vacation Care. Todos los derechos reservados.",
                            // General
                            "welcome": "Bienvenido a Pet Vacation Care",
                            "subtitle": "El mejor lugar para tus amigos peludos.",
                            "loading": "Cargando...",
                            "actions": "Acciones",
                            "edit": "Editar",
                            "delete": "Eliminar",
                            "save": "Guardar",
                            "cancel": "Cancelar",
                            "add": "Añadir",
                            // Login & Register
                            "login_title": "Iniciar Sesión",
                            "register_title": "Crear una cuenta",
                            "email": "Correo electrónico",
                            "password": "Contraseña",
                            "name": "Nombre completo",
                            "login_cta": "¿No tienes una cuenta?",
                            "register_cta": "¿Ya tienes una cuenta?",
                            // Dashboard
                            "dashboard_title": "Tu Panel",
                            "my_pets": "Mis Mascotas",
                            "my_stays": "Mis Estancias",
                            "add_pet": "Añadir Mascota",
                            "add_stay": "Añadir Estancia",
                            "pet_name": "Nombre de la mascota",
                            "pet_type": "Tipo (Perro, Gato, etc.)",
                            "pet_breed": "Raza",
                            "stay_start_date": "Fecha de inicio",
                            "stay_duration": "Duración (días)",
                            "stay_status": "Estado",
                            // Worker Dashboard
                            "admin_users": "Gestionar Usuarios",
                            "admin_pets": "Gestionar Mascotas",
                            "admin_stays": "Gestionar Estancias",
                            "user_role": "Rol",
                            // Alerts
                            "alert_success_title": "¡Éxito!",
                            "alert_register_success": "Registro exitoso. Ahora puedes iniciar sesión.",
                            "alert_login_success": "Inicio de sesión exitoso.",
                            "alert_error_title": "¡Ups!",
                            "alert_login_error": "Correo o contraseña incorrectos.",
                            "alert_delete_pet_error": "No puedes eliminar esta mascota mientras tenga una estancia activa.",
                            "alert_delete_pet_error_footer": "¿Por qué ocurre esto?",
                            "alert_confirm_delete_title": "¿Estás seguro?",
                            "alert_confirm_delete_text": "¡No podrás revertir esto!",
                            "alert_confirm_button": "Sí, ¡elimínalo!",
                            "alert_cancel_button": "Cancelar",
                        }
                    },
                    en: {
                        translation: {
                            // Navbar & Footer
                            "nav_home": "Home",
                            "nav_dashboard": "Dashboard",
                            "nav_login": "Login",
                            "nav_register": "Register",
                            "nav_logout": "Logout",
                            "theme_toggle": "Toggle theme",
                            "lang_toggle": "Change language",
                            "footer_text": "© 2025 Pet Vacation Care. All rights reserved.",
                             // General
                            "welcome": "Welcome to Pet Vacation Care",
                            "subtitle": "The best place for your furry friends.",
                            "loading": "Loading...",
                            "actions": "Actions",
                            "edit": "Edit",
                            "delete": "Delete",
                            "save": "Save",
                            "cancel": "Cancel",
                            "add": "Add",
                            // Login & Register
                            "login_title": "Login to your account",
                            "register_title": "Create an account",
                            "email": "Email address",
                            "password": "Password",
                            "name": "Full name",
                            "login_cta": "Don't have an account?",
                            "register_cta": "Already have an account?",
                            // Dashboard
                            "dashboard_title": "Your Dashboard",
                            "my_pets": "My Pets",
                            "my_stays": "My Stays",
                            "add_pet": "Add Pet",
                            "add_stay": "Add Stay",
                            "pet_name": "Pet's name",
                            "pet_type": "Type (Dog, Cat, etc.)",
                            "pet_breed": "Breed",
                            "stay_start_date": "Start date",
                            "stay_duration": "Duration (days)",
                            "stay_status": "Status",
                            // Worker Dashboard
                            "admin_users": "Manage Users",
                            "admin_pets": "Manage Pets",
                            "admin_stays": "Manage Stays",
                            "user_role": "Role",
                            // Alerts
                            "alert_success_title": "Success!",
                            "alert_register_success": "Registration successful. You can now log in.",
                            "alert_login_success": "Login successful.",
                            "alert_error_title": "Oops...",
                            "alert_login_error": "Incorrect email or password.",
                            "alert_delete_pet_error": "You cannot delete this pet while it has an active stay.",
                            "alert_delete_pet_error_footer": "Why is this happening?",
                            "alert_confirm_delete_title": "Are you sure?",
                            "alert_confirm_delete_text": "You won't be able to revert this!",
                            "alert_confirm_button": "Yes, delete it!",
                            "alert_cancel_button": "Cancel",
                        }
                    }
                };
                await i18next
                    .use(i18nextBrowserLanguageDetector)
                    .init({
                        debug: true,
                        fallbackLng: 'en',
                        resources
                    });
                this.updateContent();
            },
            t: (key) => i18next.t(key),
            changeLanguage: (lang) => {
                i18next.changeLanguage(lang, () => {
                    i18n.updateContent();
                    router.route(); // Re-render the current view with the new language
                });
            },
            updateContent: () => {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.innerHTML = i18next.t(key);
                });
            }
        };

        // ===================================================================================
        // ALERTS MODULE (src/js/alerts.js)
        // ===================================================================================
        const alerts = {
            success: (title, text) => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                });
                Toast.fire({
                    icon: "success",
                    title: title || i18n.t('alert_success_title'),
                    text: text || ''
                });
            },
            error: (title, text, footer) => {
                Swal.fire({
                    icon: "error",
                    title: title || i18n.t('alert_error_title'),
                    text: text,
                    footer: footer ? `<a href="#">${footer}</a>` : undefined
                });
            },
            confirm: (title, text) => {
                return Swal.fire({
                    title: title || i18n.t('alert_confirm_delete_title'),
                    text: text || i18n.t('alert_confirm_delete_text'),
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: i18n.t('alert_confirm_button'),
                    cancelButtonText: i18n.t('alert_cancel_button')
                });
            }
        };

        // ===================================================================================
        // AUTH MODULE (src/js/auth.js)
        // ===================================================================================
        const auth = {
            getCurrentUser: () => {
                try {
                    return JSON.parse(localStorage.getItem('currentUser'));
                } catch (e) {
                    return null;
                }
            },
            login: async (email, password) => {
                const users = await api.find('users', { _expand: 'role' });
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    // No guardar la contraseña en localStorage
                    const { password, ...userToStore } = user;
                    localStorage.setItem('currentUser', JSON.stringify(userToStore));
                    alerts.success(i18n.t('alert_login_success'));
                    return userToStore;
                }
                alerts.error(i18n.t('alert_error_title'), i18n.t('alert_login_error'));
                return null;
            },
            register: async (name, email, password) => {
                const users = await api.find('users');
                if (users.some(u => u.email === email)) {
                    alerts.error(i18n.t('alert_error_title'), 'El correo electrónico ya está en uso.');
                    return null;
                }
                // Por defecto, los nuevos usuarios son 'customer' (roleId: 1)
                const newUser = await api.create('users', { name, email, password, roleId: 1 });
                alerts.success(i18n.t('alert_success_title'), i18n.t('alert_register_success'));
                return newUser;
            },
            logout: () => {
                localStorage.removeItem('currentUser');
                window.location.hash = '/login';
            },
            // Guardian de rutas
            authGuard: (route) => {
                const user = auth.getCurrentUser();
                if (route.authRequired && !user) {
                    window.location.hash = '/login';
                    return false;
                }
                if ((route.path === '/login' || route.path === '/register') && user) {
                    window.location.hash = '/dashboard';
                    return false;
                }
                return true;
            }
        };

        // ===================================================================================
        // THEME MODULE
        // ===================================================================================
        const theme = {
            init: () => {
                const toggle = document.getElementById('theme-toggle');
                if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.body.classList.add('dark');
                }
                toggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark');
                    const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
                    localStorage.setItem('theme', theme);
                });
            }
        }

        // ===================================================================================
        // COMPONENTS (src/components/*.js)
        // ===================================================================================
        const Navbar = {
            render: () => {
                const user = auth.getCurrentUser();
                const container = document.getElementById('navbar-container');
                container.innerHTML = `
                    <nav class="shadow-md" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center">
                                    <a href="#/" class="flex-shrink-0 text-xl font-bold" style="color: var(--accent-color);">
                                        <i class="fas fa-paw mr-2"></i>
                                        <span data-i18n="nav_home"></span>
                                    </a>
                                    <div class="hidden md:block">
                                        <div class="ml-10 flex items-baseline space-x-4">
                                            ${user ? `<a href="#/dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav_dashboard"></a>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    ${!user ? `
                                        <a href="#/login" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav_login"></a>
                                        <a href="#/register" class="ml-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white btn-primary" data-i18n="nav_register"></a>
                                    ` : `
                                        <span class="mr-4 text-sm" style="color: var(--text-secondary);">${user.name}</span>
                                        <button id="logout-btn" class="nav-link px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav_logout"></button>
                                    `}
                                    <div class="ml-4 flex items-center">
                                        <button id="lang-es" class="p-1 rounded-full text-sm ${i18next.language.startsWith('es') ? 'font-bold' : ''}" style="color: var(--text-secondary);">ES</button>
                                        <span class="mx-1" style="color: var(--border-color);">|</span>
                                        <button id="lang-en" class="p-1 rounded-full text-sm ${i18next.language.startsWith('en') ? 'font-bold' : ''}" style="color: var(--text-secondary);">EN</button>
                                    </div>
                                    <button id="theme-toggle" class="ml-4 p-2 rounded-full" style="color: var(--text-secondary);" data-i18n-title="theme_toggle">
                                        <i class="fas fa-moon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
                i18n.updateContent();
            },
            attachListeners: () => {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', auth.logout);
                }
                document.getElementById('lang-es').addEventListener('click', () => i18n.changeLanguage('es'));
                document.getElementById('lang-en').addEventListener('click', () => i18n.changeLanguage('en'));
                theme.init();
            }
        };

        const Footer = {
            render: () => {
                const container = document.getElementById('footer-container');
                container.innerHTML = `<p data-i18n="footer_text"></p>`;
                i18n.updateContent();
            }
        };

        // ===================================================================================
        // VIEWS (src/views/*.js)
        // ===================================================================================
        const homeView = {
            render: () => `
                <div class="text-center py-16 px-4 sm:px-6 lg:px-8">
                    <h1 class="text-4xl font-extrabold tracking-tight sm:text-5xl md:text-6xl" data-i18n="welcome"></h1>
                    <p class="mt-3 max-w-md mx-auto text-lg sm:text-xl md:mt-5 md:max-w-3xl" style="color: var(--text-secondary);" data-i18n="subtitle"></p>
                    <div class="mt-5 max-w-md mx-auto sm:flex sm:justify-center md:mt-8">
                        <div class="rounded-md shadow">
                            <a href="#/register" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white btn-primary md:py-4 md:text-lg md:px-10" data-i18n="nav_register"></a>
                        </div>
                        <div class="mt-3 rounded-md shadow sm:mt-0 sm:ml-3">
                            <a href="#/login" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md btn-primary bg-indigo-100 text-indigo-700 hover:bg-indigo-200 md:py-4 md:text-lg md:px-10" data-i18n="nav_login"></a>
                        </div>
                    </div>
                </div>
            `,
            attachListeners: () => {}
        };

        const loginView = {
            render: () => `
                <div class="flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold" data-i18n="login_title"></h2>
                        </div>
                        <form id="login-form" class="mt-8 space-y-6">
                            <div class="rounded-md shadow-sm -space-y-px">
                                <div>
                                    <label for="email-address" class="sr-only" data-i18n="email"></label>
                                    <input id="email-address" name="email" type="email" autocomplete="email" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="${i18n.t('email')}">
                                </div>
                                <div>
                                    <label for="password" class="sr-only" data-i18n="password"></label>
                                    <input id="password" name="password" type="password" autocomplete="current-password" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="${i18n.t('password')}">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <span data-i18n="nav_login"></span>
                                </button>
                            </div>
                        </form>
                        <p class="mt-2 text-center text-sm" style="color: var(--text-secondary);">
                            <span data-i18n="login_cta"></span>
                            <a href="#/register" class="font-medium" style="color: var(--accent-color);" data-i18n="nav_register"></a>
                        </p>
                    </div>
                </div>
            `,
            attachListeners: () => {
                document.getElementById('login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = e.target.email.value;
                    const password = e.target.password.value;
                    const user = await auth.login(email, password);
                    if (user) {
                        window.location.hash = '/dashboard';
                    }
                });
            }
        };

        const registerView = {
            render: () => `
                <div class="flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div>
                            <h2 class="mt-6 text-center text-3xl font-extrabold" data-i18n="register_title"></h2>
                        </div>
                        <form id="register-form" class="mt-8 space-y-6">
                            <div class="rounded-md shadow-sm -space-y-px">
                                <div>
                                    <input id="name" name="name" type="text" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="${i18n.t('name')}">
                                </div>
                                <div>
                                    <input id="email-address" name="email" type="email" autocomplete="email" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="${i18n.t('email')}">
                                </div>
                                <div>
                                    <input id="password" name="password" type="password" autocomplete="new-password" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="${i18n.t('password')}">
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <span data-i18n="nav_register"></span>
                                </button>
                            </div>
                        </form>
                        <p class="mt-2 text-center text-sm" style="color: var(--text-secondary);">
                            <span data-i18n="register_cta"></span>
                            <a href="#/login" class="font-medium" style="color: var(--accent-color);" data-i18n="nav_login"></a>
                        </p>
                    </div>
                </div>
            `,
            attachListeners: () => {
                document.getElementById('register-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = e.target.name.value;
                    const email = e.target.email.value;
                    const password = e.target.password.value;
                    const newUser = await auth.register(name, email, password);
                    if (newUser) {
                        window.location.hash = '/login';
                    }
                });
            }
        };

        const dashboardView = {
            render: () => {
                const user = auth.getCurrentUser();
                if (!user) return `<p data-i18n="loading"></p>`;

                const isWorker = user.role.name === 'worker';

                return `
                    <div class="prose max-w-none">
                        <h1 data-i18n="dashboard_title"></h1>
                        <p>${i18n.t('welcome')}, ${user.name}!</p>
                    </div>
                    
                    <div id="dashboard-content" class="mt-8 space-y-8">
                        ${isWorker ? `
                            <div id="admin-users-section"></div>
                            <div id="admin-pets-section"></div>
                            <div id="admin-stays-section"></div>
                        ` : `
                            <div id="customer-pets-section"></div>
                            <div id="customer-stays-section"></div>
                        `}
                    </div>
                `;
            },
            attachListeners: () => {
                const user = auth.getCurrentUser();
                if (!user) return;

                if (user.role.name === 'worker') {
                    // Cargar y mostrar todas las secciones para el worker
                    dashboardView.loadAdminUsers();
                    dashboardView.loadAdminPets();
                    dashboardView.loadAdminStays();
                } else {
                    // Cargar y mostrar secciones para el customer
                    dashboardView.loadCustomerPets();
                    dashboardView.loadCustomerStays();
                }
            },
            
            // --- Métodos para Customer ---
            loadCustomerPets: async () => {
                const user = auth.getCurrentUser();
                const section = document.getElementById('customer-pets-section');
                if (!section) return;

                const pets = await api.find('pets', { userId: user.id });
                section.innerHTML = `
                    <div class="card rounded-lg shadow-md overflow-hidden">
                        <div class="p-5 flex justify-between items-center">
                            <h2 class="text-xl font-bold" data-i18n="my_pets"></h2>
                            <button id="add-pet-btn" class="btn-primary text-sm font-medium rounded-md px-4 py-2" data-i18n="add_pet"></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                                <thead style="background-color: var(--bg-primary);">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_name"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_type"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_breed"></th>
                                        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider" data-i18n="actions"></th>
                                    </tr>
                                </thead>
                                <tbody id="pets-table-body">
                                    ${pets.map(p => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${p.type}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${p.breed}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button class="edit-pet-btn" data-id="${p.id}" style="color: var(--accent-color);" data-i18n="edit"></button>
                                                <button class="delete-pet-btn ml-4" data-id="${p.id}" style="color: #ef4444;" data-i18n="delete"></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                i18n.updateContent();
                document.getElementById('add-pet-btn').addEventListener('click', () => dashboardView.showPetModal());
                document.querySelectorAll('.edit-pet-btn').forEach(btn => btn.addEventListener('click', (e) => dashboardView.showPetModal(e.target.dataset.id)));
                document.querySelectorAll('.delete-pet-btn').forEach(btn => btn.addEventListener('click', (e) => dashboardView.deletePet(e.target.dataset.id)));
            },
            
            loadCustomerStays: async () => {
                const user = auth.getCurrentUser();
                const section = document.getElementById('customer-stays-section');
                if (!section) return;

                const stays = await api.find('stays', { userId: user.id, _expand: 'pet' });
                const pets = await api.find('pets', { userId: user.id });

                section.innerHTML = `
                    <div class="card rounded-lg shadow-md overflow-hidden">
                        <div class="p-5 flex justify-between items-center">
                            <h2 class="text-xl font-bold" data-i18n="my_stays"></h2>
                            <button id="add-stay-btn" class="btn-primary text-sm font-medium rounded-md px-4 py-2" data-i18n="add_stay"></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                                <thead style="background-color: var(--bg-primary);">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_name"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="stay_start_date"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="stay_duration"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="stay_status"></th>
                                    </tr>
                                </thead>
                                <tbody id="stays-table-body">
                                    ${stays.map(s => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.pet?.name || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.startDate}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.duration}</td>
                                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${s.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${s.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                i18n.updateContent();
                document.getElementById('add-stay-btn').addEventListener('click', () => dashboardView.showStayModal(pets));
            },

            showPetModal: async (petId = null) => {
                const user = auth.getCurrentUser();
                const pet = petId ? await api.findOne('pets', petId) : { name: '', type: '', breed: '' };
                
                Swal.fire({
                    title: petId ? i18n.t('edit') + ' ' + i18n.t('my_pets') : i18n.t('add_pet'),
                    html: `
                        <input id="swal-pet-name" class="swal2-input" placeholder="${i18n.t('pet_name')}" value="${pet.name}">
                        <input id="swal-pet-type" class="swal2-input" placeholder="${i18n.t('pet_type')}" value="${pet.type}">
                        <input id="swal-pet-breed" class="swal2-input" placeholder="${i18n.t('pet_breed')}" value="${pet.breed}">
                    `,
                    focusConfirm: false,
                    preConfirm: () => {
                        return {
                            name: document.getElementById('swal-pet-name').value,
                            type: document.getElementById('swal-pet-type').value,
                            breed: document.getElementById('swal-pet-breed').value,
                        }
                    },
                    showCancelButton: true,
                    confirmButtonText: i18n.t('save'),
                    cancelButtonText: i18n.t('cancel'),
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        if (petId) {
                            await api.update('pets', petId, result.value);
                        } else {
                            await api.create('pets', { ...result.value, userId: user.id });
                        }
                        alerts.success(i18n.t('alert_success_title'), 'Mascota guardada.');
                        dashboardView.loadCustomerPets();
                    }
                });
            },

            showStayModal: async (pets) => {
                const user = auth.getCurrentUser();
                if (pets.length === 0) {
                    alerts.error(i18n.t('alert_error_title'), 'Debes añadir una mascota primero.');
                    return;
                }

                Swal.fire({
                    title: i18n.t('add_stay'),
                    html: `
                        <select id="swal-pet-id" class="swal2-input">
                            ${pets.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                        <input id="swal-start-date" type="date" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">
                        <input id="swal-duration" type="number" class="swal2-input" placeholder="${i18n.t('stay_duration')}" min="1">
                    `,
                    focusConfirm: false,
                    preConfirm: () => {
                        return {
                            petId: parseInt(document.getElementById('swal-pet-id').value),
                            startDate: document.getElementById('swal-start-date').value,
                            duration: parseInt(document.getElementById('swal-duration').value),
                        }
                    },
                    showCancelButton: true,
                    confirmButtonText: i18n.t('save'),
                    cancelButtonText: i18n.t('cancel'),
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        if (!result.value.startDate || !result.value.duration) {
                            alerts.error(i18n.t('alert_error_title'), 'Todos los campos son requeridos.');
                            return;
                        }
                        await api.create('stays', { ...result.value, userId: user.id, status: 'active' });
                        alerts.success(i18n.t('alert_success_title'), 'Estancia creada.');
                        dashboardView.loadCustomerStays();
                    }
                });
            },

            deletePet: async (petId) => {
                // Verificar si la mascota tiene estancias activas
                const stays = await api.find('stays', { petId: petId });
                if (stays.some(s => s.status === 'active')) {
                    alerts.error(
                        i18n.t('alert_error_title'), 
                        i18n.t('alert_delete_pet_error'),
                        i18n.t('alert_delete_pet_error_footer')
                    );
                    return;
                }

                alerts.confirm().then(async (result) => {
                    if (result.isConfirmed) {
                        await api.remove('pets', petId);
                        alerts.success(i18n.t('alert_success_title'), 'Mascota eliminada.');
                        dashboardView.loadCustomerPets();
                        dashboardView.loadCustomerStays(); // Recargar estancias por si alguna estaba asociada
                    }
                });
            },

            // --- Métodos para Worker (pueden ser implementados de forma similar) ---
            loadAdminUsers: async () => {
                 const section = document.getElementById('admin-users-section');
                 if (!section) return;
                 const users = await api.find('users', { _expand: 'role' });
                 section.innerHTML = `
                    <div class="card rounded-lg shadow-md overflow-hidden">
                        <div class="p-5"><h2 class="text-xl font-bold" data-i18n="admin_users"></h2></div>
                        <div class="overflow-x-auto">
                             <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                                <thead style="background-color: var(--bg-primary);">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="name"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="email"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="user_role"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map(u => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${u.id}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${u.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${u.email}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${u.role.name}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                 `;
                 i18n.updateContent();
            },
            loadAdminPets: async () => {
                 const section = document.getElementById('admin-pets-section');
                 if (!section) return;
                 const pets = await api.find('pets', { _expand: 'user' });
                 section.innerHTML = `
                    <div class="card rounded-lg shadow-md overflow-hidden">
                        <div class="p-5"><h2 class="text-xl font-bold" data-i18n="admin_pets"></h2></div>
                        <div class="overflow-x-auto">
                             <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                                <thead style="background-color: var(--bg-primary);">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_name"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_type"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Dueño</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pets.map(p => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${p.type}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${p.user?.name || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                 `;
                 i18n.updateContent();
            },
            loadAdminStays: async () => {
                 const section = document.getElementById('admin-stays-section');
                 if (!section) return;
                 const stays = await api.find('stays', { _expand: 'pet' });
                 section.innerHTML = `
                    <div class="card rounded-lg shadow-md overflow-hidden">
                        <div class="p-5"><h2 class="text-xl font-bold" data-i18n="admin_stays"></h2></div>
                        <div class="overflow-x-auto">
                             <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                                <thead style="background-color: var(--bg-primary);">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="pet_name"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="stay_start_date"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="stay_duration"></th>
                                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-i18n="stay_status"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stays.map(s => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.pet?.name || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.startDate}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.duration}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${s.status}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                 `;
                 i18n.updateContent();
            },
        };

        const notFoundView = {
            render: () => `
                <div class="text-center py-16">
                    <h1 class="text-9xl font-extrabold" style="color: var(--accent-color);">404</h1>
                    <p class="text-2xl font-semibold mt-4">Página no encontrada</p>
                    <p class="mt-2" style="color: var(--text-secondary);">Lo sentimos, no pudimos encontrar la página que buscas.</p>
                    <a href="#/" class="mt-6 inline-block btn-primary text-white font-bold py-2 px-4 rounded">Volver al inicio</a>
                </div>
            `,
            attachListeners: () => {}
        };

        // ===================================================================================
        // ROUTER (src/js/router.js)
        // ===================================================================================
        const router = {
            routes: {
                '/': { view: homeView, authRequired: false },
                '/login': { view: loginView, authRequired: false },
                '/register': { view: registerView, authRequired: false },
                '/dashboard': { view: dashboardView, authRequired: true }
            },
            route: () => {
                // Renderizar componentes estáticos
                Navbar.render();
                Navbar.attachListeners();
                Footer.render();

                // Obtener la ruta actual
                const path = window.location.hash.slice(1) || '/';
                const route = router.routes[path] || { view: notFoundView, authRequired: false };

                // Aplicar guardián
                if (!auth.authGuard(route)) {
                    return; // La navegación fue redirigida por el guardián
                }

                // Renderizar la vista
                const app = document.getElementById('app');
                app.innerHTML = route.view.render();
                route.view.attachListeners();
                i18n.updateContent();
            }
        };

        // ===================================================================================
        // ENTRY POINT (src/js/main.js)
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            await i18n.init();
            window.addEventListener('hashchange', router.route);
            router.route(); // Cargar la ruta inicial
        });

    </script>
</body>
</html>
